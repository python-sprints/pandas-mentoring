# Adapted from https://github.com/numba/numba/blob/master/azure-pipelines.yml
pr:
  branches:
    exclude:
    - master

jobs:
- job: 'Docs'
  condition: |
    and(eq(variables['Build.Reason'], 'PullRequest'),
    ne(variables['Build.SourceBranch'], 'refs/heads/master'))
  pool:
    vmImage: ubuntu-16.04
  timeoutInMinutes: 90
  steps:
  - script: |
      echo '##vso[task.setvariable variable=ENV_FILE]environment.yml'
      echo '##vso[task.prependpath]$(HOME)/miniconda3/bin'
    displayName: 'Setting environment variables'

  - script: |
      sudo apt-get install -y libc6-dev-i386
      ci/setup_env.sh
    displayName: 'Install Miniconda'

  - script: |
      source activate pandas-docs
      cd doc/
      make html
    displayName: 'Build documentation'
  - script: |
      cd doc/build/html
      git init
      touch .nojekyll
      echo "dev.pandas.io" > CNAME
      printf "User-agent: *\nDisallow: /" > robots.txt
      git add --all .
      git config user.email "pandas-mentoring-ci@pandas.org"
      git config user.name "pandas-mentoring-ci"
      git commit -m "pandas documentation in master"
    displayName: 'Create git repo for docs build'
    condition : |
      and(not(eq(variables['Build.Reason'], 'PullRequest')),
          eq(variables['Build.SourceBranch'], 'refs/heads/master'))

    # For `InstallSSHKey@0` to work, next steps are required:
    # 1. Generate a pair of private/public keys (i.e. `ssh-keygen -t rsa -b 4096 -C "your_email@example.com"`)
    # 2. Go to "Library > Secure files" in the Azure Pipelines dashboard: https://dev.azure.com/pandas-dev/pandas/_library?itemType=SecureFiles
    # 3. Click on "+ Secure file"
    # 4. Upload the private key (the name of the file must match with the specified in "sshKeySecureFile" input below, "pandas_docs_key")
    # 5. Click on file name after it is created, tick the box "Authorize for use in all pipelines" and save
    # 6. The public key specified in "sshPublicKey" is the pair of the uploaded private key, and needs to be set as a deploy key of the repo where the docs will be pushed (with write access): https://github.com/pandas-dev/pandas-dev.github.io/settings/keys
  - task: InstallSSHKey@0
    inputs:
      hostName: 'github.com,192.30.252.128 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=='
      sshPublicKey: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCtG+MWrDGt7dHml+IJT9VCmibD7VTCGkax1EBUiCNaao4XhMZycZJLoRWkTtFIvFW323YPc0H892fAp+8HFCNOp4FpKVoThhs+NghUCvpEK/eifsWUrcQakyoyH+19tcuCUWYaXuF8O70y6FL+fWhzRfITRUdQC697l+zw3s39Up80xTC2QQXaWsv54PfZYQbiVvL9mrufIoJ569W27hKmv742euVfoQzcgfX+FAhChWroBM7WtqLpVVFgcMfB37uOCUKxBkECJvRzOuH4c8yXK0UQAdrIsiy89QUEvG2GobHl9MnYjbkSlFCt03Q4rPwrGIvM1R7XnTma9QkRYcHFKYaYhGQhAnux+fNEEGmw/ssWMnqE0wb4cmt4/l/K4VYwPiMok/WWwgGbwedjTahXMyFkXt8lnR7lQwDHjy/ZOw9ZYcZF/7FnjlKyC0QfXc8TLk1E0v84S6lvoMnYwFTS2dwEd/N2O4fGHC+TXI9B2upa3FB6P2ef+6rYZBdKcJvq8WZd9dqxn71pEtXHA3iI2+gx4VZq1Q+BQ6CHSYgoNsJFo7atO455MKMM3B2d2/D2/GfD3sygB1B09OCAjf8MrnRIGjkkaUXqzbvLp0BkKemH0VUu4SQr8028gsSvuLizNphdgLN0EI/rfM+Ln1zglHi5PBc4f2WURyntFNSeuQ== bhava0895@gmail.com'
      sshKeySecureFile: 'pandas-mentoring-docs'
    displayName: 'Install GitHub ssh deployment key'
    condition : |
      and(not(eq(variables['Build.Reason'], 'PullRequest')),
          eq(variables['Build.SourceBranch'], 'refs/heads/master'))

  - script: |
      cd doc/build/html
      git remote add origin git@github.com:python-sprints/pandas-mentoring-docs.git
      git push -f origin master
    displayName: 'Publish docs to GitHub pages'
    condition : |
      and(not(eq(variables['Build.Reason'], 'PullRequest')),
          eq(variables['Build.SourceBranch'], 'refs/heads/master'))
